<!DOCTYPE html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.0//EN" "http://www.wapforum.org/DTD/xhtml-mobile10.dtd">
<html>

<head>
    <title>myGame1-beta</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    <link rel="stylesheet" href="css/reset.css">
</head>

<body>
</body>
<script src="js/jquery-1.8.3.min.js"></script>
<script src="js/jquery.easing.min.js"></script>
<script>
window.myGame = function() {
    this._p = []; //矩阵
    this.numbers = 0;
    this.obj = []; //本次点击被消除的点
    this.alldisplay = []; //储存空列的列号
    this.dismiss = 0; //已经空了的列数
    this.score = 0; //本局分数
}
myGame.prototype.creatP = function() {
    for (var i = 0; i < 10; i++) {
        this._p[i] = [];
        for (var j = 0; j < 10; j++) {
            this._p[i][j] = randomNum(Math.floor(Math.random() * 5));
        }
    }

    function randomNum(num) {
        switch (num) {
            case 0:
                return '#F33F3F';
            case 1:
                return '#156FE5';
            case 2:
                return '#0BEA21';
            case 3:
                return '#EED511';
            case 4:
                return '#D747D2';
        }
    }
}
myGame.prototype.panintP = function() {
    var $div = $(`
        <div style="width:100%;" id="mydiv">
            <svg  style="width:100%;" class="svg" viewBox="0 0 0 0" />
            <p>最高分:${localStorage.mosthigh}分</p>
            <p>当前分数:${this.score}分</p>
            <button>重新开始</button>
        </div>
        `);
    $('body').append($div);
    var winWidth = $("html").width();
    this.numbers = winWidth;
    $(".svg").height(winWidth);
    var winHeight = $("html").height();
    this.settings(winWidth);
}
myGame.prototype.repaintP = function(winWidth) {
    var str = '';
    for (var flag = 0, i = 20; flag < 10; flag++) {
        for (var num = 0, j = 20; num < 10; num++) {
            if (this._p[num][flag]) {
                str = str.concat(`<rect width="${winWidth / 11}" height="${winWidth / 11}"
                             style="fill:${this._p[num][flag]};stroke-width:1;stroke:rgb(0,0,0)"
                                x="${i}" y="${j}" rx='5' ry='5' />`);
            } else {
                str = str.concat(`<rect width="${winWidth / 11}" height="${winWidth / 11}"
                             style="fill:${this._p[num][flag]};display:none"
                                x="${i}" y="${j}" rx='5' ry='5' />`);
            }
            j += winWidth / 11;
        }
        i += winWidth / 11;
    }
    $(".svg").html(str);

}
myGame.prototype.settings = function(winWidth) { //界面元素的一些设置
    document.getElementsByClassName('svg')[0].setAttribute('viewBox', `0 0 ${winWidth} ${winWidth}`);
    $('p').css('top', function(index){return $('svg').height()+40+index*45 + 'px'});
}
myGame.prototype.init = function() {
    this.creatP();
    this.panintP();
    this.bindEvens();
    this.repaintP(this.numbers);
}
myGame.prototype.createText = function(str, time) { //创建文字区域
    var $p = `<strong class=${parseInt(str)}>${str}</strong>`;
    $('#mydiv strong').remove();
    $('#mydiv').append($p);
    setTimeout(function() {
        $('.' + parseInt(str)).remove();
    }, time);
}
myGame.prototype.restart = function() {
    this.creatP();
    this.repaintP(this.numbers);
    this.reset();
    this.removeEvents();
    this.bindEvens();
    this.dismiss = 0; //已经空了的列数
    this.score = 0; //本局分数
    this.createText('重新开始！',1000);
    $('p:eq(1)').html('当前分数:' + this.score + '分');
}
myGame.prototype.reset = function() {
    this.obj = [];
    this.alldisplay = [];
}
myGame.prototype.removeEvents = function() {
    this.obj = [];
    this.alldisplay = [];
    $('button').off('touchstart');
    $('.svg').off('touchstart');
}
myGame.prototype.bindEvens = function() {
    var _this = this;
    $('button').on('touchstart',function(){
        _this.restart();
        $('button').css('background-color','#7FD7FC');
        setTimeout(function(){
        $('button').css('background-color','white');},200);
    })
    $('.svg').on('touchstart', function(event) {
        _this.reset();
        var e = e || event;
        if (e.originalEvent.targetTouches[1]) {} else {
            var touch = e.originalEvent.targetTouches[0];
            var target = _this.getCenter(touch);
            if (target) {
                _this.display(_this._p[target[0]][target[1]],target[0],target[1]); //递归四周
                _this.handleP(); //矩阵处理
                _this.repaintP(_this.numbers); //重画矩阵
                _this.touchending(); //判定结束
            }
        }
    })
}
myGame.prototype.display = function(str, i,j) { //点击的对象递归四周
    if (this._p[i]) {
        if (this._p[i][j]) {
            if (this._p[i][j] == str) {
                this._p[i][j] = 0;
                // $('.svg rect').eq(j*10+i).css('display','none');
                this.obj.push({
                    i: i,
                    j: j,
                    str: str
                });
                this.display(str, i + 1, j);
                this.display(str, i, j + 1);
                this.display(str, i - 1, j);
                this.display(str, i, j - 1);
            }
        }
    }
}
// easeInCubic1 easeOutCubic easeInOutCubic
// easeInQuint easeOutQuint easeInOutQuint
// easeInSine easeOutSine easeInOutSine
// easeInExpo easeOutExpo easeInOutExpo
// easeInCirc easeOutCirc easeInOutCirc
// easeInElastic easeOutElastic easeInOutElastic
// easeInBack easeOutBack easeInOutBack
// easeInBounce easeOutBounce easeInOutBounce
myGame.prototype.toPosition=function(nowAdays,x,y){
    var x=x||0;
    var y=y||0;
    var X=parseInt($(nowAdays).attr('x'));
    var Y=parseInt($(nowAdays).attr('y'));
    $(nowAdays).animate({"x":X+"px","y":-5+Y+"px"},'fast').animate({"x":x+X+"px","y":y+Y+"px"},"2000",'easeInQuint');
    console.log($(nowAdays).html());
}
myGame.prototype.getCenter = function(touch) { //获取circle的中心点坐标
    var X = touch.pageX;
    var Y = touch.pageY;
    var nowAdays = document.elementFromPoint(X, Y);
    var key = $('.svg rect').index($(nowAdays));
    if (nowAdays.nodeName == 'rect') {
        return [key % 10, Math.floor(key / 10)];
    } else {
        return false;
    }
}
myGame.prototype.checkIfOver = function() { //检查游戏是否结束
    for (var i = 0; i < 10; i++) {
        for (var j = 0; j < 10; j++) {
            if (this._p[i][j]) {
                if (this._p[i][j + 1]) {
                    if (this._p[i][j] == this._p[i][j + 1]) {
                        return false;
                    }
                }
                if (this._p[i + 1]) {
                    if (this._p[i][j] == this._p[i + 1][j]) {
                        return false;
                    }
                }
            }
        }
    }
    return true;
}
myGame.prototype.gameover = function() { //如果游戏结束，算出还剩多少方块
    if (this.checkIfOver()) {
        var num = 0;
        for (var i = 0; i < 10; i++) {
            for (var j = 0; j < 10; j++) {
                if (this._p[i][j]) {
                    num++;
                }
            }
        }
        return num;
    } else {
        return false;
    }
}
myGame.prototype.handleP = function() { //处理矩阵，把空方块往右上移动
    if (this.obj.length == 1) { //如果消除的是一个，则不允许消除
        this._p[this.obj[0].i][this.obj[0].j] = this.obj[0].str;
        this.obj = [];
    } else {
        this.obj.sort(function(a, b) {
            return a.i - b.i;
        });
        for (var n = 0; n < this.obj.length; n++) {
            for (var number = this.obj[n].i; number >= 0; number--) { //把0方块往上推
                if (number == 0) {} else {
                    if (this._p[number - 1][this.obj[n].j]) {
                        this._p[number][this.obj[n].j] = this._p[number - 1][this.obj[n].j];
                        this._p[number - 1][this.obj[n].j] = 0;
                    }
                }
            }
        }
        for (var n = 0; n < 10 - this.dismiss; n++) { //如果有空列，就push，每消除一列，就少监测一列，10-this.dismiss
            if (this._p[9][n] == 0) {
                this.alldisplay.push(n);
            }
        }
        this.alldisplay.sort(function(a, b) {
            return b - a;
        });
        for (var j = 0; j < this.alldisplay.length; j++) { //把空列往右边推
            for (n = this.alldisplay[j]; n < 10; n++) {
                for (var m = 0; m < 10; m++) {
                    this._p[m][n] = this._p[m][n + 1];
                    this._p[m][n + 1] = 0;
                }
            }
            this.dismiss++; //推完dismiss++
        }
        this.createText(this.calcu(this.obj.length), 1000);

        // for (var i = 0; i <= 9; i++) {
        //     console.log(this._p[i][0] + ' ' + this._p[i][1] + ' ' + this._p[i][2] + ' ' + this._p[i][3] + ' ' + this._p[i][4] + ' ' + this._p[i][5] + ' ' +
        //         this._p[i][6] + ' ' + this._p[i][7] + ' ' + this._p[i][8] + ' ' + this._p[i][9])
        // }
    }
}
myGame.prototype.touchending = function() {
    var gameRest = this.gameover();
    if (gameRest) { //如果最后剩余十个以内，奖励分
        var str = '';
        var str2='';
            if (gameRest < 10) {
                this.score += (10 - gameRest) * 300;
                $('p:eq(1)').html('当前分数:' + this.score + '分');
                str2 = '+'+(10 - gameRest) * 200+',';
            }
            if (localStorage.mosthigh) {
                if (localStorage.mosthigh >= this.score) {
                    this.createText(str2 + '真可惜,差一点就破纪录了', 5000);
                } else {
                    localStorage.mosthigh = this.score;
                    this.createText(str2 + '游戏结束,新纪录！', 5000);
                }
            } else {
                localStorage.mosthigh = this.score;
                this.createText(str2 + '游戏结束,新纪录！', 5000);
            }
             $('.svg').off("touchstart");
        }
    
}
myGame.prototype.calcu = function(length) {
    var num;
    switch (length) {
        case length >= 10:
            num = Math.pow(length, 2) * 4 + length * 3 + 30;
            break;
        case length >= 5:
            num = Math.pow(length, 2) * 3 + length * 3 + 30;
            break;
        default:
            num = Math.pow(length, 2) * 2 + length * 3 + 30;
            break;
    }
    this.score += num;
    $('p:eq(1)').html('当前分数:' + this.score + '分');
    if (num >= 400) {
        return '+' + num + '!!!'
    } else {
        return '+' + num;
    }
}
var myGame1 = new myGame();
myGame1.init();
</script>

</html>
